import os
import sys
import pytest
from streamlit.testing.v1 import AppTest

# Ensure project root is on path
PROJECT_ROOT = os.path.abspath(os.path.join(os.path.dirname(__file__), ".."))
if PROJECT_ROOT not in sys.path:
    sys.path.insert(0, PROJECT_ROOT)

called = {}
async def dummy_process_prompt(prompt):
    called['prompt'] = prompt

def test_app(monkeypatch):
    import importlib
    import client.client
    monkeypatch.setattr(client.client, 'process_prompt', dummy_process_prompt)
    import app.cmd.streamlit_app as app_module
    importlib.reload(app_module)
    at = AppTest.from_file('app/cmd/streamlit_app.py')
    at.run()
    at.text_area[0].input('test input')
    at.button[0].click()
    at.run(timeout=5)
    assert called.get('prompt') == 'test input'